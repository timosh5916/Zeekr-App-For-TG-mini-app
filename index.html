<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zikr Switch</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-dark: #121212; --text-white: #ffffff; --accent-green: #2ecc71; --radius-lg: 24px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-white); height: 100vh; overflow: hidden; }
        .bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://images.unsplash.com/photo-1543791187-df796fa11835?q=80&w=1000&auto=format&fit=crop') no-repeat center center; background-size: cover; filter: blur(30px) brightness(0.4); z-index: -1; }
        .view { display: none; width: 100%; height: 100%; padding: 20px; overflow-y: auto; padding-bottom: 100px; }
        .view.active { display: block; animation: fadeOp 0.25s ease-out; }
        @keyframes fadeOp { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
        
        /* –ì–ª–∞–≤–Ω–∞—è */
        .home-header { font-size: 13px; font-weight: 700; letter-spacing: 1px; color: #b0b0b0; margin-bottom: 15px; text-transform: uppercase; }
        .grid-2x2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .menu-card { border-radius: var(--radius-lg); padding: 16px; height: 130px; display: flex; flex-direction: column; justify-content: space-between; background: #252528; position: relative; transition: transform 0.1s; }
        .menu-card:active { transform: scale(0.98); }
        .card-morning { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white; }
        .card-evening { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white; }
        .menu-title { font-size: 16px; font-weight: 700; line-height: 1.2; }
        .menu-sub { font-size: 13px; opacity: 0.8; margin-top: 5px; }
        .menu-icon { font-size: 22px; }

        /* –°–ø–∏—Å–æ–∫ */
        .list-item { background: white; border-radius: 20px; padding: 16px; margin-bottom: 10px; color: black; position: relative; min-height: 80px; transition: background 0.2s; }
        .list-item:active { background: #f0f0f0; }
        .badge { position: absolute; top: 0; left: 16px; background: #009688; color: white; width: 24px; height: 32px; border-radius: 0 0 10px 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; padding-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .list-content { margin-left: 35px; margin-right: 30px; margin-top: 5px; }
        .list-title { font-weight: 700; font-size: 17px; margin-bottom: 6px; }
        .list-preview { font-size: 13px; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-stats { margin-top: 12px; font-size: 12px; color: #999; font-weight: 500; }
        .fav-star { position: absolute; top: 16px; right: 16px; font-size: 20px; color: #ddd; }

/* === –≠–ö–†–ê–ù –°–ß–ï–¢–ß–ò–ö–ê (–ñ–ï–°–¢–ö–ê–Ø –§–ò–ö–°–ê–¶–ò–Ø) === */
        #view-detail {
            display: none; 
            flex-direction: column; 
            height: 100vh; /* –≠–∫—Ä–∞–Ω —Ä–æ–≤–Ω–æ –ø–æ –≤—ã—Å–æ—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
            padding: 20px; 
            padding-bottom: 30px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
            overflow: hidden; /* –ó–ê–ü–†–ï–©–ê–ï–ú –°–ö–†–û–õ–õ –í–°–ï–ì–û –≠–ö–†–ê–ù–ê */
        }
        #view-detail.active {
            display: flex; 
            animation: fadeOp 0.25s ease-out;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ —Å–≤–µ—Ä—Ö—É) */
        .text-card { 
            flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –≤—ã—Å–æ—Ç—É –∫—Ä–æ–º–µ —Å—á–µ—Ç—á–∏–∫–∞ */
            background: #eef1f5; 
            border-radius: 32px; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ –∫—Ä–∞—è–º –∫–∞—Ä—Ç–æ—á–∫–∏ */
        }
        
        /* –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
/* –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card-tools { 
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 20px 20px 0 20px; background: #eef1f5; z-index: 10;
            flex-shrink: 0; 
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä–æ–ª–ª–∞) */
        .zikr-title-small { 
            font-size: 13px; text-transform: uppercase; color: #888; 
            letter-spacing: 1px; margin-bottom: 20px; text-align: center; 
            font-weight: 700;
        }
        
        .tool-btn { 
            width: 32px; height: 32px; border-radius: 50%; border: 1px solid #ccc; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 16px; color: #555; cursor: pointer; background: white; 
        }

        /* –°–ê–ú–û–ï –ì–õ–ê–í–ù–û–ï: –û–ë–õ–ê–°–¢–¨ –°–ö–†–û–õ–õ–ê */
        .text-scroll-area {
            flex: 1; 
            overflow-y: auto; 
            padding: 10px 20px 80px 20px;
            text-align: center;
        }
        .text-scroll-area::-webkit-scrollbar { width: 0; display: none; }
        .text-scroll-area { -ms-overflow-style: none; scrollbar-width: none; }


/* –ò–î–ï–ê–õ–¨–ù–´–ô –ê–†–ê–ë–°–ö–ò–ô –¢–ï–ö–°–¢ (–ö–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–∞—Ö) */
        .arabic-text { 
            font-family: 'Amiri', serif; 
            font-size: 28px; /* –ò–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –Ω–µ —Å–ª–∏—à–∫–æ–º –æ–≥—Ä–æ–º–Ω—ã–π */
            line-height: 2.2; /* –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –æ–≥–ª–∞—Å–æ–≤–∫–∏ –Ω–µ —Å–ª–∏–ø–∞—é—Ç—Å—è */
            margin-bottom: 25px; 
            direction: rtl; 
            color: #111;
            text-align: center;
        }
        
        .trans-text { 
            font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #222; line-height: 1.5; 
        }
        .mean-text { 
            font-size: 15px; color: #555; line-height: 1.5; 
        }
        
        /* –ö–Ω–æ–ø–∫–∞ Play */
        .play-audio { 
            position: absolute; bottom: 20px; right: 20px; 
            width: 44px; height: 44px; background: #222; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
        }

        /* –ü–∞–Ω–µ–ª—å —Å—á–µ—Ç—á–∏–∫–∞ (–ù–∏–∂–Ω—è—è) */
        .counter-panel { 
            height: 25vh; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—á–µ—Ç—á–∏–∫–∞ */
            flex-shrink: 0; /* –ù–µ –¥–∞–µ–º —Å—á–µ—Ç—á–∏–∫—É —Å–∂–∏–º–∞—Ç—å—Å—è */
            background: rgba(80, 80, 80, 0.6); backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); border-radius: 32px; 
            position: relative; display: flex; align-items: center; 
            justify-content: center; border: 1px solid rgba(255,255,255,0.1); 
        }
        .counter-big { font-size: 96px; font-weight: 300; font-family: 'Roboto', sans-serif; color: white; margin-bottom: 10px; }
        .target-display { position: absolute; top: 25px; right: 30px; font-size: 16px; color: rgba(255,255,255,0.8); font-weight: 600; }
        .total-display { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); font-size: 16px; color: rgba(255,255,255,0.5); font-weight: 400; }
        .mic-btn { position: absolute; bottom: 25px; right: 30px; font-size: 26px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.3s; z-index: 10; }
        .mic-btn.active { color: #ff5252; transform: scale(1.2); filter: drop-shadow(0 0 10px rgba(255, 82, 82, 0.6)); }
        .mic-btn.disabled { opacity: 0.2; pointer-events: none; }
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .float-back { position: fixed; bottom: 30px; left: 20px; width: 50px; height: 50px; background: rgba(40,40,40,0.9); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(5px); display: none; z-index: 100; }
        .float-close { position: fixed; bottom: 30px; right: 20px; width: 50px; height: 50px; background: rgba(40,40,40,0.9); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; backdrop-filter: blur(5px); z-index: 100; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 85%; max-height: 80%; overflow-y: auto; border-radius: 20px; padding: 25px; color: #333; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="bg-layer"></div>

    <div id="view-home" class="view active">
        <div class="home-header">–ó–ò–ö–†</div>
        <div class="grid-2x2">
            <div class="menu-card" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><div class="menu-icon">‚óé</div><div><div class="menu-title">–í—Å–µ –∑–∏–∫—Ä—ã</div><div class="menu-sub">41 –∑–∏–∫—Ä–æ–≤</div></div></div>
            <div class="menu-card" onclick="alert('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ')"><div class="menu-icon">‚òÖ</div><div><div class="menu-title">–ú–æ–µ<br>–∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div><div class="menu-sub">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</div></div></div>
            <div class="menu-card card-morning" onclick="openList('morning')"><div class="menu-icon">‚òÄ</div><div><div class="menu-title">–£—Ç—Ä–µ–Ω–Ω–∏–µ<br>–∞–∑–∫–∞—Ä—ã</div><div class="menu-sub">14 –∞–∑–∫–∞—Ä–æ–≤</div></div></div>
            <div class="menu-card card-evening" onclick="openList('morning')"><div class="menu-icon">üåô</div><div><div class="menu-title">–í–µ—á–µ—Ä–Ω–∏–µ<br>–∞–∑–∫–∞—Ä—ã</div><div class="menu-sub">14 –∞–∑–∫–∞—Ä–æ–≤</div></div></div>
        </div>
        <div class="home-header" style="margin-top:20px;">–í–∞—à–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
        <div class="grid-2x2">
            <div class="menu-card" style="height:110px; background:#1c1c1e; justify-content:flex-end;"><div style="font-weight:600;">–°—É—Ä–∞ –∞–Ω-–ù–∞—Å</div><div style="font-size:12px; color:#777;">3 / 3 (154)</div></div>
            <div class="menu-card" style="height:110px; background:#1c1c1e; justify-content:flex-end;"><div style="font-weight:600;">–ö–æ–ª–ª–µ–∫—Ü–∏—è</div><div style="font-size:12px; color:#777;">0 / 455</div></div>
        </div>
    </div>

    <div id="view-list" class="view">
        <div class="home-header" id="listTitle">–°–ü–ò–°–û–ö</div>
        <div id="listContainer"></div>
    </div>

<div id="view-detail" class="view">
            <div class="text-card">
            <div class="card-tools">
                <div class="tool-btn">‚Ä¢‚Ä¢‚Ä¢</div>
                <div class="tool-btn" onclick="showInfo()" style="font-family:serif; font-weight:bold; font-style:italic;">i</div>
            </div>

            <div class="text-scroll-area">
                <div class="zikr-title-small" id="detTitle">–ó–ê–ì–û–õ–û–í–û–ö</div>
                <div class="arabic-text" id="detArabic"></div>
                <div class="trans-text" id="detTrans"></div>
                <div class="mean-text" id="detMean"></div>
            </div>
            
            <div class="play-audio" onclick="tg.HapticFeedback.notificationOccurred('warning')">‚ñ∂</div>
        </div>

        <div class="counter-panel" id="tapArea">
            <div class="counter-big" id="countNum">0</div>
            <div class="target-display" id="targetNum">0</div>
            <div class="total-display" id="totalNum">0</div>
            <div class="mic-btn" id="micBtn">üéô</div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-content"><h3 style="color:#009688; margin-top:0;">–ö–æ–Ω—Ç–µ–∫—Å—Ç</h3><p id="infoText" style="line-height:1.6; font-size:15px;"></p><div style="text-align:right; margin-top:20px; color:#009688; font-weight:bold; cursor:pointer;" onclick="document.getElementById('infoModal').style.display='none'">–ó–ê–ö–†–´–¢–¨</div></div>
    </div>

    <div class="float-back" id="btnBack" onclick="goBack()">‚Üê</div>
    <div class="float-close" onclick="tg.close()">‚úï</div>

    <script src="data.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ö–ª—é—á–∏ –¥–ª—è localStorage
        const STORAGE_KEY = 'zikr_app_data_v3';
        const DATE_KEY = 'zikr_app_date_v3';

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentListKey = 'morning';
        let currentIndex = 0;
        let viewHistory = ['view-home'];

        // === 1. –ú–ò–ö–†–û–§–û–ù ===
        let recognition;
        let isListening = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechAPI();
            recognition.continuous = true;
            recognition.lang = 'ar-SA';
            recognition.interimResults = false;
            recognition.onresult = () => incrementCounter();
            recognition.onerror = () => stopListening();
        }

        document.getElementById('micBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const item = db[currentListKey][currentIndex];
            if (!item.allowMic) { tg.showAlert("–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –¥—É–∞ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞"); return; }
            if (isListening) stopListening(); else startListening();
        });

        function startListening() { if(!recognition) return; recognition.start(); isListening = true; document.getElementById('micBtn').classList.add('active'); tg.HapticFeedback.notificationOccurred('success'); }
        function stopListening() { if(!recognition) return; recognition.stop(); isListening = false; document.getElementById('micBtn').classList.remove('active'); }

        // === 2. –ó–ê–ì–†–£–ó–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ===
        function loadData() {
            const lastDate = localStorage.getItem(DATE_KEY);
            const today = new Date().toDateString();
            let isNewDay = (lastDate !== today);
            if (isNewDay) localStorage.setItem(DATE_KEY, today);

            const savedRaw = localStorage.getItem(STORAGE_KEY);
            if (savedRaw) {
                const savedDB = JSON.parse(savedRaw);
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã —Å –±–∞–∑–æ–π –∏–∑ data.js
                for (const section in db) {
                    if (savedDB[section]) {
                        db[section].forEach((item, i) => {
                            const savedItem = savedDB[section][i];
                            if (savedItem) {
                                item.total = savedItem.total || 0;
                                item.current = isNewDay ? 0 : (savedItem.current || 0);
                            }
                        });
                    }
                }
            }
        }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

        // === 3. –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
        function openList(key) {
            currentListKey = key;
            const listData = db[key];
            if (!listData) return;
            document.getElementById('listTitle').innerText = key === 'morning' ? "–£–¢–†–ï–ù–ù–ò–ï –ê–ó–ö–ê–†–´" : "–°–ü–ò–°–û–ö";
            const container = document.getElementById('listContainer');
            container.innerHTML = "";
            listData.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => openDetail(idx);
                div.innerHTML = `<div class="badge">${idx+1}</div><div class="list-content"><div class="list-title">${item.title}</div><div class="list-preview">${item.trans}</div><div class="list-stats">${item.current} / ${item.target} (${item.total.toLocaleString()})</div></div><div class="fav-star">‚òÜ</div>`;
                container.appendChild(div);
            });
            changeView('view-list');
        }

        function openDetail(idx) {
            currentIndex = idx;
            stopListening();
            renderDetail();
            changeView('view-detail');
        }

        function changeView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            viewHistory.push(id);
            document.getElementById('btnBack').style.display = (id === 'view-home') ? 'none' : 'flex';
        }

        function goBack() {
            stopListening();
            if(viewHistory.length > 1) {
                viewHistory.pop();
                const prev = viewHistory[viewHistory.length-1];
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(prev).classList.add('active');
                document.getElementById('btnBack').style.display = (prev === 'view-home') ? 'none' : 'flex';
                if(prev === 'view-list') openList(currentListKey);
            }
        }

        // === 4. –õ–û–ì–ò–ö–ê –°–ß–ï–¢–ß–ò–ö–ê ===
        function renderDetail() {
            const item = db[currentListKey][currentIndex];
            document.getElementById('detTitle').innerText = item.title;
            document.getElementById('detArabic').innerText = item.arabic;
            document.getElementById('detTrans').innerText = item.trans;
            document.getElementById('detMean').innerText = item.mean;
            document.getElementById('infoText').innerText = item.info;
            const micBtn = document.getElementById('micBtn');
            if (item.allowMic) micBtn.classList.remove('disabled'); else micBtn.classList.add('disabled');
            updateCounterUI();
        }

function updateCounterUI() {
            const item = db[currentListKey][currentIndex];
            const bigDisplay = document.getElementById('countNum');

            // –õ–û–ì–ò–ö–ê –ì–ê–õ–û–ß–ö–ò: –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–Ω–æ —Ü–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 3, 6, 9...)
            if (item.target > 0 && item.current > 0 && item.current % item.target === 0) { 
                bigDisplay.innerHTML = "‚úî"; 
                bigDisplay.style.color = "#2ecc71"; // –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞
            } else { 
                bigDisplay.innerText = item.current; 
                
                // –ï—Å–ª–∏ —Ü–µ–ª—å —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ –º—ã –∫–ª–∏–∫–∞–µ–º –¥–∞–ª—å—à–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä 4/3), —Ü–∏—Ñ—Ä–∞ –±—É–¥–µ—Ç –∑–µ–ª–µ–Ω–æ–π
                if (item.target > 0 && item.current >= item.target) {
                    bigDisplay.style.color = "#2ecc71"; 
                } else {
                    bigDisplay.style.color = "white"; // –û–±—ã—á–Ω—ã–π —Ü–≤–µ—Ç
                }
            }

            document.getElementById('targetNum').innerText = item.target;
            document.getElementById('totalNum').innerText = item.total.toLocaleString();
        }

        function incrementCounter() {
            const item = db[currentListKey][currentIndex];
            item.current++; item.total++;
            saveData();
            updateCounterUI();
            const bigDisplay = document.getElementById('countNum');
            bigDisplay.style.transform = "scale(1.15)";
            setTimeout(() => bigDisplay.style.transform = "scale(1)", 100);
            tg.HapticFeedback.impactOccurred('light');
        }

        document.getElementById('tapArea').addEventListener('click', (e) => {
            if(e.target.id === 'micBtn') return;
            incrementCounter();
        });

        function showInfo() { document.getElementById('infoModal').style.display = 'flex'; }

        // –ó–∞–ø—É—Å–∫
        loadData();
    </script>
</body>
</html>